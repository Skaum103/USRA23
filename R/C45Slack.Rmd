---
output:
  pdf_document: default
  html_document: default
---
### Preparation

Run this cell to clear the variables in your global R environment.

```{r}
rm(list = ls())
ls()
```

## Libraries

```{r}
library(caret)
library(RWeka)
library(dplyr)
```


## Data files
```{r}
slack.lab.1.noVPN = read.csv("t2/slack/none/lab/slackPcapFixGapLab1_flows.csv")
slack.lab.1.1111 = read.csv("t2/slack/1.1.1.1/lab/slackPcapFixGapLab1_1111_flows.csv")
slack.lab.1.noVPN
slack.lab.1.1111

# Drop Src.ipaddr && Dest.ipaddr && start,end time && mac
drops <- c("srcIP",  "dstIP","srcMac", "dstMac", "timeFirst", "timeLast",
          "srcIPCC", "dstIPCC", "srcIPOrg", "dstIPOrg", "srcMac_dstMac_numP", "dstPortClass", "srcMacLbl_dstMacLbl", "ethVlanID",
          "hdrDesc",
          "vlanID")

#"srcIPOrg", "dstIPOrg", 
slack.lab.1.noVPN <- slack.lab.1.noVPN[, !(names(slack.lab.1.noVPN) %in% drops)]
slack.lab.1.1111 <- slack.lab.1.1111[, !(names(slack.lab.1.1111) %in% drops)]
sum(is.na(slack.lab.1.noVPN))
sum(is.na(slack.lab.1.1111))

# Add a new column, isVPN, set to 0 for no_vpn, 1 for 1111
slack.lab.1.noVPN$isVPN <- 0
slack.lab.1.1111$isVPN <- 1

# Show summary

slack.lab.1.noVPN = data.frame(slack.lab.1.noVPN)
slack.lab.1.1111 = data.frame(slack.lab.1.1111)
```

## Prepare Data

```{r}
# Find length of the no_vpn table
n_noVPN = length(slack.lab.1.noVPN$flowInd)
n_noVPN
# Find length of the vpn table
n_VPN = length(slack.lab.1.1111$flowInd)
n_VPN

if (n_noVPN > n_VPN) {
  nTrain = n_VPN*0.7
} else {
  nTrain = n_noVPN*0.7
}

# Define Training set & Testing set
prop = nTrain/(nrow(slack.lab.1.noVPN))
prop
set.seed(123)
trnrows_noVPN  <- sample(nrow(slack.lab.1.noVPN),nrow(slack.lab.1.noVPN)*prop)
dtrain_noVPN <- slack.lab.1.noVPN[ trnrows_noVPN,]
dtest_noVPN  <- slack.lab.1.noVPN[-trnrows_noVPN,]

trnrows_1111  <- sample(nrow(slack.lab.1.1111),nrow(slack.lab.1.1111)*0.7)
dtrain_1111 <- slack.lab.1.1111[ trnrows_1111,]
dtest_1111  <- slack.lab.1.1111[-trnrows_1111,]

dtrain <- rbind(dtrain_noVPN,dtrain_1111)
dtest <- rbind(dtest_1111,dtest_noVPN)

# Remove all columns with only 1 unique value
dtrain <- dtrain %>% select(where(~ n_distinct(.) > 1))
dtrain$isVPN <- as.factor(dtrain$isVPN)

dtest <- dtest %>% select(where(~ n_distinct(.) > 1))
dtest$isVPN <- as.factor(dtest$isVPN)

#dtest <- dtest[, !(names(dtest) %in% c("tcpSeqFaultCnt"))]

nrow(dtest)
nrow(dtrain)
ncol(dtrain)
```


## Train Model

```{r}

train_control<- trainControl(method="cv", number=10)
C45Fit <- train(isVPN ~., method="J48", data=dtrain,
                tuneLength = 5,
                trControl = train_control)

```



## Validation
```{r}
C45Fit
C45Fit$finalModel


predictions = predict(C45Fit, newdata = dtest)
confusionMatrix(predictions, dtest$isVPN)
```


## Load more files
```{r}
slack.lab.3.noVPN = read.csv("t2/slack/none/lab/slackPcapFixGapLab3_flows.csv")
slack.lab.3.1111 = read.csv("t2/slack/1.1.1.1/lab/slackPcapFixGapLab3_1111_flows.csv")


# Drop Src.ipaddr && Dest.ipaddr && start,end time && mac
slack.lab.3.noVPN <- slack.lab.3.noVPN[, !(names(slack.lab.3.noVPN) %in% drops)]
slack.lab.3.1111 <- slack.lab.3.1111[, !(names(slack.lab.3.1111) %in% drops)]
sum(is.na(slack.lab.3.noVPN))
sum(is.na(slack.lab.3.1111))

# Add a new column, isVPN, set to 0 for no_vpn, 1 for 1111
slack.lab.3.noVPN$isVPN <- 0
slack.lab.3.1111$isVPN <- 1

# Show summary
slack.lab.3.noVPN = data.frame(slack.lab.3.noVPN)
slack.lab.3.1111 = data.frame(slack.lab.3.1111)

slack.lab.3.data <- rbind(slack.lab.3.1111,slack.lab.3.noVPN)

# Remove all columns with only 1 unique value
slack.lab.3.data <- slack.lab.3.data %>% select(where(~ n_distinct(.) > 1))

nrow(slack.lab.3.data)
ncol(slack.lab.3.data)

```

## Predicate
```{r}
predictions = predict(C45Fit, newdata = slack.lab.3.data)
confusionMatrix(predictions, as.factor(slack.lab.3.data$isVPN))
```