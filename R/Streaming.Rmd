---
output:
  pdf_document: default
  html_document: default
---

### Preparation

Run this cell to clear the variables in your global R environment.

```{r}
rm(list = ls())
ls()
```

## Libraries

```{r}
library(caret)
library(RWeka)
library(dplyr)
library(caTools)
library(randomForest)
```


## Define basics
```{r}
# Drop Src.ipaddr && Dest.ipaddr && start,end time && mac
drops <- c("srcIP",  "dstIP","srcMac", "dstMac", "timeFirst", "timeLast",
          "srcIPCC", "dstIPCC", "srcIPOrg", "dstIPOrg", "srcMac_dstMac_numP", "dstPortClass", "srcMacLbl_dstMacLbl", "ethVlanID",
          "hdrDesc",
          "vlanID",
          "icmpBFTypH_TypL_Code", "ipOptCnt", "ipOptCpCl_Num")

```


## Data file process function
```{r}
load_data <- function(data) {
  data.noVPN <- get(paste(data, "noVPN", sep = "."))
  data.1111 <- get(paste(data, "1111", sep = "."))
  
  data.noVPN <- data.noVPN[, !(names(data.noVPN) %in% drops)]
  data.1111 <- data.1111[, !(names(data.1111) %in% drops)]
  
  data.noVPN$isVPN <- 0
  data.1111$isVPN <- 1
  
  data.noVPN = data.frame(data.noVPN)
  data.1111 = data.frame(data.1111)
  data.data <- rbind(data.1111,data.noVPN)
  
  assign(paste(data, "noVPN", sep = "."), data.noVPN, envir = globalenv())
  assign(paste(data, "1111", sep = "."), data.1111, envir = globalenv())
  assign(paste(data, "data", sep = "."), data.data, envir = globalenv())
}
```


## Load data files
```{r}
twitch.lab.10.noVPN = read.csv("t2/streaming/none/lab/streamingCapLab10_flows.csv")
twitch.lab.1.noVPN = read.csv("t2/streaming/none/lab/streamingCapLab1_flows.csv")
twitch.lab.3.noVPN = read.csv("t2/streaming/none/lab/streamingCapLab3_flows.csv")
twitch.lab.6.noVPN = read.csv("t2/streaming/none/lab/streamingCapLab6_flows.csv")
twitch.lab.8.noVPN = read.csv("t2/streaming/none/lab/streamingCapLab8_flows.csv")

twitch.lab.10.1111 = read.csv("t2/streaming/1.1.1.1/lab/streamingCapLab10_1111_flows.csv")
twitch.lab.1.1111 = read.csv("t2/streaming/1.1.1.1/lab/streamingCapLab1_1111_flows.csv")
twitch.lab.3.1111 = read.csv("t2/streaming/1.1.1.1/lab/streamingCapLab3_1111_flows.csv")
twitch.lab.6.1111 = read.csv("t2/streaming/1.1.1.1/lab/streamingCapLab6_1111_flows.csv")
twitch.lab.8.1111 = read.csv("t2/streaming/1.1.1.1/lab/streamingCapLab8_1111_flows.csv")

twitch.res.10.noVPN = read.csv("t2/streaming/none/res/streamingCapRes10_flows.csv")
twitch.res.1.noVPN = read.csv("t2/streaming/none/res/streamingCapRes1_flows.csv")
twitch.res.3.noVPN = read.csv("t2/streaming/none/res/streamingCapRes3_flows.csv")
twitch.res.6.noVPN = read.csv("t2/streaming/none/res/streamingCapRes6_flows.csv")
twitch.res.8.noVPN = read.csv("t2/streaming/none/res/streamingCapRes8_flows.csv")

twitch.res.10.1111 = read.csv("t2/streaming/1.1.1.1/res/streamingCapRes10_1111_flows.csv")
twitch.res.1.1111 = read.csv("t2/streaming/1.1.1.1/res/streamingCapRes1_1111_flows.csv")
twitch.res.3.1111 = read.csv("t2/streaming/1.1.1.1/res/streamingCapRes3_1111_flows.csv")
twitch.res.6.1111 = read.csv("t2/streaming/1.1.1.1/res/streamingCapRes6_1111_flows.csv")
twitch.res.8.1111 = read.csv("t2/streaming/1.1.1.1/res/streamingCapRes8_1111_flows.csv")

twitch.lab.noVPN <- rbind(twitch.lab.10.noVPN,twitch.lab.1.noVPN,twitch.lab.3.noVPN,
                        twitch.lab.6.noVPN,twitch.lab.8.noVPN)
twitch.lab.1111 <- rbind(twitch.lab.10.1111,twitch.lab.1.1111,twitch.lab.3.1111,
                        twitch.lab.6.1111,twitch.lab.8.1111)
twitch.lab.data <- rbind(twitch.lab.noVPN,twitch.lab.1111)

twitch.res.noVPN <- rbind(twitch.res.10.noVPN,twitch.res.1.noVPN,twitch.res.3.noVPN,
                          twitch.res.6.noVPN,twitch.res.8.noVPN)
twitch.res.1111 <- rbind(twitch.res.10.1111,twitch.res.1.1111,twitch.res.3.1111,
                         twitch.res.6.1111,twitch.res.8.1111)

twitch.data.noVPN <- rbind(twitch.lab.noVPN,twitch.res.noVPN)
twitch.data.1111 <- rbind(twitch.lab.1111,twitch.res.1111)
twitch.data <- rbind(twitch.data.1111,twitch.data.noVPN)


```


## Clean data - define cols to drop
```{r}
s <- twitch.data %>% select(where(~ n_distinct(.) <= 1))
drops <- c(drops,colnames(s))
drops

load_data("twitch.lab.10")
load_data("twitch.lab.1")
load_data("twitch.lab.3")
load_data("twitch.lab.6")
load_data("twitch.lab.8")

load_data("twitch.res.10")
load_data("twitch.res.1")
load_data("twitch.res.3")
load_data("twitch.res.6")
load_data("twitch.res.8")

twitch.lab.noVPN <- rbind(twitch.lab.10.noVPN,twitch.lab.1.noVPN,twitch.lab.3.noVPN,
                        twitch.lab.6.noVPN,twitch.lab.8.noVPN)
twitch.lab.1111 <- rbind(twitch.lab.10.1111,twitch.lab.1.1111,twitch.lab.3.1111,
                        twitch.lab.6.1111,twitch.lab.8.1111)
twitch.lab.data <- rbind(twitch.lab.noVPN,twitch.lab.1111)

twitch.res.noVPN <- rbind(twitch.res.10.noVPN,twitch.res.1.noVPN,twitch.res.3.noVPN,
                          twitch.res.6.noVPN,twitch.res.8.noVPN)
twitch.res.1111 <- rbind(twitch.res.10.1111,twitch.res.1.1111,twitch.res.3.1111,
                         twitch.res.6.1111,twitch.res.8.1111)

twitch.data.noVPN <- rbind(twitch.lab.noVPN,twitch.res.noVPN)
twitch.data.1111 <- rbind(twitch.lab.1111,twitch.res.1111)
twitch.data <- rbind(twitch.data.1111,twitch.data.noVPN)

```
## Process data function
```{r}
process_data <- function(data) {
  data.noVPN <- get(paste(data, "noVPN", sep = "."))
  data.1111 <- get(paste(data, "1111", sep = "."))
  
  data.prop = nrow(data.1111)*0.7 / nrow(data.noVPN)
  
  data.noVPN.trnRows  <- sample(nrow(data.noVPN),nrow(data.noVPN)*data.prop)
  data.noVPN.dtrain <- data.noVPN[ data.noVPN.trnRows,]
  data.noVPN.dtest  <- data.noVPN[-data.noVPN.trnRows,]

  data.1111.trnRows <- sample(nrow(data.1111),nrow(data.1111)*0.7)
  data.1111.dtrain <- data.1111[ data.1111.trnRows,]
  data.1111.dtest  <- data.1111[-data.1111.trnRows,]

  data.dtrain <- rbind(data.noVPN.dtrain,data.1111.dtrain)
  data.dtest <- rbind(data.noVPN.dtest,data.1111.dtest)

  data.dtrain$isVPN <- as.factor(data.dtrain$isVPN)
  data.dtest$isVPN <- as.factor(data.dtest$isVPN)
  
  assign(paste(data, "dtest", sep = "."), data.dtest, envir = globalenv())
  assign(paste(data, "dtrain", sep = "."), data.dtrain, envir = globalenv())
  assign(paste(data, "data", sep = "."), rbind(data.dtrain,data.dtest), envir = globalenv())
}

```


## Process data for trainning
```{r}
process_data("twitch.lab")
process_data("twitch.res")

```

## Models - C45
```{r}
train_control<- trainControl(method="cv", number=10)
twitch.lab.C45Model <- train(isVPN ~., method="J48", data=twitch.lab.dtrain,
                tuneLength = 5,
                trControl = train_control)

twitch.res.C45Model <- train(isVPN ~., method="J48", data=twitch.res.dtrain,
                tuneLength = 5,
                trControl = train_control)

```


## Validation - C45 - lab
```{r}
twitch.lab.C45Model$finalModel

print("lab")
predictions.lab.lab = predict(twitch.lab.C45Model, newdata = twitch.lab.dtest)
confMatrixes.lab.lab <- confusionMatrix(predictions.lab.lab, twitch.lab.dtest$isVPN)
eva.twitch.c45.lab.lab <- confMatrixes.lab.lab$byClass
eva.twitch.c45.lab.lab
confMatrixes.lab.lab$overall

print("res")
predictions.lab.res = predict(twitch.lab.C45Model, newdata = twitch.res.data)
confMatrixes.lab.res <- confusionMatrix(predictions.lab.res, twitch.res.data$isVPN)
eva.twitch.c45.lab.res <- confMatrixes.lab.res$byClass
eva.twitch.c45.lab.res
confMatrixes.lab.res$overall
```


## Validation - C45 - res
```{r}
twitch.res.C45Model$finalModel

print("res")
predictions.res.res = predict(twitch.res.C45Model, newdata = twitch.res.dtest)
confMatrixes.res.res <- confusionMatrix(predictions.res.res, twitch.res.dtest$isVPN)
eva.twitch.c45.res.res <- confMatrixes.res.res$byClass
eva.twitch.c45.res.res
confMatrixes.res.res$overall

print("lab")
predictions.res.lab = predict(twitch.res.C45Model, newdata = twitch.lab.data)
confMatrixes.res.lab <- confusionMatrix(predictions.res.lab, twitch.lab.data$isVPN)
eva.twitch.c45.res.lab <- confMatrixes.res.lab$byClass
eva.twitch.c45.res.lab
confMatrixes.res.lab$overall

```

## Models - Random Forest
```{r}

# Fitting Random Forest to the train dataset
set.seed(1003)  # Setting seed
repeat_cv <- trainControl(method = "repeatedcv", number = 10, repeats = 3)

twitch.lab.classifier_RF = randomForest(x = twitch.lab.dtrain[-81],
                             y = twitch.lab.dtrain$isVPN,
                             ntree = 500,
                             trControl = repeat_cv)

twitch.res.classifier_RF = randomForest(x = twitch.res.dtrain[-81],
                             y = twitch.res.dtrain$isVPN,
                             ntree = 500,
                             trControl = repeat_cv)

# Importance plot
importance(twitch.lab.classifier_RF)
importance(twitch.res.classifier_RF)
  
# Variable importance plot
varImpPlot(twitch.lab.classifier_RF)
varImpPlot(twitch.res.classifier_RF)

```


## Validation - Random Forest - lab
```{r}

print("lab")
predictions.lab.lab.rf = predict(twitch.lab.classifier_RF, newdata = twitch.lab.dtest)
confMatrixes.lab.lab.rf <- confusionMatrix(predictions.lab.lab.rf, twitch.lab.dtest$isVPN)
eva.twitch.c45.lab.lab.rf <- confMatrixes.lab.lab.rf$byClass
eva.twitch.c45.lab.lab.rf
confMatrixes.lab.lab.rf$overall

print("res")
predictions.lab.res.rf = predict(twitch.lab.classifier_RF, newdata = twitch.res.data)
confMatrixes.lab.res.rf <- confusionMatrix(predictions.lab.res.rf, twitch.res.data$isVPN)
eva.twitch.c45.lab.res.rf <- confMatrixes.lab.res.rf$byClass
eva.twitch.c45.lab.res.rf
confMatrixes.lab.res.rf$overall

```


## Validation - Random Forest - res
```{r}
print("res")
predictions.res.res.rf = predict(twitch.res.classifier_RF, newdata = twitch.res.dtest)
confMatrixes.res.res.rf <- confusionMatrix(predictions.res.res.rf, twitch.res.dtest$isVPN)
eva.twitch.c45.res.res.rf <- confMatrixes.res.res.rf$byClass
eva.twitch.c45.res.res.rf
confMatrixes.res.res.rf$overall

print("lab")
predictions.res.lab.rf = predict(twitch.res.classifier_RF, newdata = twitch.lab.data)
confMatrixes.res.lab.rf <- confusionMatrix(predictions.res.lab.rf, twitch.lab.data$isVPN)
eva.twitch.c45.res.lab.rf <- confMatrixes.res.lab.rf$byClass
eva.twitch.c45.res.lab.rf
confMatrixes.res.lab.rf$overall
```
## Drop no-numeric columns
```{r}
library(glmnet)
library(tidyverse)
twitch.lab.data <- twitch.lab.data[, !(names(twitch.lab.data) %in% c("X.dir", "ipOptCpCl_Num"))]
twitch.res.data <- twitch.res.data[, !(names(twitch.res.data) %in% c("X.dir", "ipOptCpCl_Num"))]
ncol(twitch.lab.data)
ncol(twitch.res.data)

```

## Models - LASSO
```{r}


```

## Validation - LASSO
```{r}

```